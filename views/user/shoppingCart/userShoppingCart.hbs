<link rel="stylesheet" href="stylesheets/shoppingcart.css">
<body>
    {{#if error}}
            <div id="flash-message" class="alert alert-danger" role="alert">
            {{error}}
            </div>
            {{/if}}
            {{#if success}}
            <div id="flash-message" class="alert alert-success" role="alert">
            {{success}}
            </div>
            {{/if}}
    <div class="container py-5">
        <div class="row">
            <aside class="col-lg-9">
                <div class="card">
                    <div class="table-responsive">
                        <table class="table table-borderless table-shopping-cart">
                            <thead class="text-muted">
                                <tr class="small text-uppercase">
                                    <th scope="col">Product</th>
                                    <th scope="col" width="120">Quantity</th>
                                    <th scope="col" width="120">Price</th>
                                    <th scope="col" class="text-right d-none d-md-block" width="200"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each cartitems}}
                                <tr>
                                    <td>
                                        <a href="/productDetails/{{variantId}}">
                                        <figure class="itemside align-items-center">
                                            <div class="aside"><img src={{productImage}} class="img-sm"></div>
                                            <figcaption class="info"> <a href="/productDetails/{{variantId}}" class="title text-dark" data-abc="true">{{productName}}</a>
                                                <p class="text-muted small">{{category}}<br>{{baseProduct}}<br>
                                                Stock: {{#if (lt stock 5)}}
                                                            <span class="stock text-danger small">{{stock}} left</span>
                                                        {{else}}
                                                            <span class="stock text-success small">In Stock</span>
                                                        {{/if}}
                                                        <br>
                                                Quantity: <span class="quantity" id="productquantity-{{variantId}}">{{quantity}}</span><br>Base Price:{{actualPrice}}</p>
                                            </figcaption>
                                        </figure>
                                        </a>
                                    </td>
                                    <td> <select class="form-control quantity-select" data-variant-id="{{variantId}}" style="width: 50%;">
                                            <option value="1" {{#if (isEqual quantity 1)}}selected{{/if}}>1</option>
                                            <option value="2" {{#if (isEqual quantity 2)}}selected{{/if}}>2</option>
                                            <option value="3" {{#if (isEqual quantity 3)}}selected{{/if}}>3</option>
                                            <option value="4" {{#if (isEqual quantity 4)}}selected{{/if}}>4</option>
                                        </select>
                                        <span id="stock-error-{{variantId}}" class="text-danger"></span>
                                    <td>
                                        <div class="price-wrap"> 
                                            <var class="price" id="total-price-{{variantId}}">{{totalPrice}}<br></var> 
                                            <small class="text-muted"> {{actualPrice}} X <span class="quantity" id="quantity-{{variantId}}"  data-base-price="{{basePrice}}">{{quantity}}</span> </small> 
                                        </div>
                                    </td>
                                    <td class="text-right d-none d-md-block ">
                                        <div class="d-flex justify-content-around">
                                        <form id="wishlistForm" method="POST" action="/addcartToWishlist">
                                        <input type="hidden" name="variantId" value="{{variantId}}">
                                        <button type="submit" class="btn btn-secondary " data-abc="true">
                                            <i class="bi bi-heart px-1"></i>
                                        </button> 
                                        </form>
                                        <form id="removeForm" method="POST" action="/removeCartProduct/{{variantId}}">
                                        <button type="submit" class="btn btn-danger " data-abc="true">
                                            <i class="bi bi-trash px-1"></i>
                                        </button> 
                                        </form>
                                        </div>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </aside>
            <aside class="col-lg-3">
                <div class="card mb-3">
                    <div class="card-body">
                        <form>
                            <div class="form-group"> <label>Have coupon?</label>
                                <div class="input-group d-flex align-items-center justify-content-around gap-2" > 
                                    <input type="text" class="form-control coupon" name="coupon" placeholder="Coupon code" style="width: 40%;"> 
                                    <span class="input-group-append"> 
                                        <button type="button" style="width: 80%;" class="btn btn-sm btn-info btn-apply-coupon" data-bs-toggle="modal" data-bs-target="#applyCouponModal">
                                            <i class="bi bi-eye"></i>
                                            </button> 
                                    </span> 
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <dl class="dlist-align">
                            <dt>Total Quantity:</dt>
                            <dd class="text-right ml-3"><strong class="total-quantity">{{totalQuantity}}</strong></dd>
                        </dl>
                        <dl class="dlist-align">
                            <dt>Total price:</dt>
                            <dd class="text-right ml-3"><strong class="total-price-of-all-products">{{totalPriceOfAllProducts}}</strong></dd>
                        </dl>
                        <dl class="dlist-align">
                            <dt>Discount:</dt>
                            <dd class="text-right text-danger ml-3"><strong class="discount-with-coupon">- 00.00</strong></dd>
                        </dl> 
                        <dl class="dlist-align">
                            <dt>Total:</dt>
                            <dd class="text-right ml-3"><strong class="total-price-with-discount-products">{{totalPriceOfAllProducts}}</strong></dd>
                        </dl>
                        <hr> <a href="/checkout" class="btn btn-out btn-primary btn-square btn-main" data-abc="true"> Make Purchase </a>
                        <a href="/" class="btn btn-out btn-success btn-square btn-main mt-2" data-abc="true">Continue Shopping</a>
                    </div>
                </div>
            </aside>
        </div>
    </div>
    <!-- Modal -->
<div class="modal fade" id="applyCouponModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="couponModalLabel">Available Coupons</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closecouponModal()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <ul id="coupon-list" class="list-group">
                    
                </ul>
            </div>
        </div>
    </div>
</div>
        <script src="/javascripts/shoppingCart.js"></script>
    <script>
        $(document).ready(function() {
            $('.btn-apply-coupon').click(function() {
                const totalAmount = $('.total-price-of-all-products').text();
                $.ajax({
                    url: '/getApplicableCoupons',
                            method: 'GET',
                            data: { totalAmount },
                            success: function(response) {
                                const coupons = response.coupons;
                                const couponList = $('#coupon-list');
                                couponList.empty();

                                if (coupons.length > 0) {
                                    coupons.forEach(coupon => {
                                        const couponItem = `<li class="list-group-item">
                                            ${coupon.name} - ${coupon.description} -<br>
                                            Discount :${coupon.discount}% -Min-Purchase ${coupon.minPurchaseAmount}-<br>
                                            PayementMethod :${coupon.paymentMethod}
                                            <button class="btn btn-link apply-coupon" data-coupon-name="${coupon.name}" data-coupon-id="${coupon._id}" data-discount="${coupon.discount}" data-payment-method="${coupon.paymentMethod}">
                                            Apply
                                            </button>
                                        </li>`;
                                        couponList.append(couponItem);
                                    });
                                } else {
                                    couponList.append('<li class="list-group-item">No coupons available</li>');
                                }
                                $('#couponModal').modal('show');
                            }
                                })
                            })

                            $(document).on('click', '.apply-coupon', function() {
                                const couponName = $(this).data('coupon-name');
                                const discount = $(this).data('discount');
                                const paymentMethod = $(this).data('payment-method')
                                const totalAmount = parseFloat($('.total-price-of-all-products').text());
                                const discountAmount = (totalAmount * discount / 100).toFixed(2);
                                const newTotal = (totalAmount - discountAmount).toFixed(2);

                                // Update the coupon input field and discount field
                                    $('.coupon').val(couponName);
                                    $('.discount-with-coupon').text(`- ${discountAmount}`);
                                    $('.total-price-with-discount-products').text(newTotal);
                                    // Change the button to "Remove"
                                    $('.btn-apply-coupon').html('<i class="bi bi-trash3"></i>').removeClass('btn-apply-coupon').addClass('btn-remove-coupon');

                                        // Update the session with the new total amount
                                                $.ajax({
                                                    url: '/updateCartTotal',
                                                    method: 'POST',
                                                    data: { newTotal,paymentMethod },
                                                    success: function(response) {
                                                        console.log(response.message);
                                                    },
                                                    error: function(error) {
                                                        console.log('Error updating cart total:', error);
                                                    }
                                                });
                                    $('#applyCouponModal').modal('hide');
                            })

                            $(document).on('click', '.btn-remove-coupon', function() {
                                // Reset the coupon input field and discount field
                                $('.coupon').val('');
                                    $('.discount-with-coupon').text('- 00.00');
                                    const originalTotal = $('.total-price-of-all-products').text();
                                    $('.total-price-with-discount-products').text(originalTotal);

                                    // Change the button back to "View Coupons"
                                    $(this).html('<i class="bi bi-eye"></i>').removeClass('btn-remove-coupon').addClass('btn-apply-coupon');

                                    // Update the session with the original total amount
                                    $.ajax({
                                        url: '/updateCartTotal',
                                        method: 'POST',
                                        data: { newTotal: originalTotal },
                                        success: function(response) {
                                            console.log(response.message);
                                        },
                                        error: function(error) {
                                            console.log('Error updating cart total:', error);
                                        }
                                    });
                            });
                        })
                        function closecouponModal(){
                            $('#applyCouponModal').modal('hide');
                        }
    </script> 
</body>
