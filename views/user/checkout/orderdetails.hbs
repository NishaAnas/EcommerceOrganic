<link rel="stylesheet" href="/stylesheets/orderdetails.css">

<body>
    <div class="container">
        <h1>Order Details</h1>
        <div class="order-summary">
            <h2>Order Summary</h2>
            <div class="order-info">
                <div class="row">
                    <div class="col">Order Id:</div>
                    <div class="col">{{ order.newOrderId}}</div>
                </div>
                <div class="row">
                    <div class="col">Order Date:</div>
                    <div class="col order-date">{{ order.orderDate}}</div>
                </div>
                <div class="row">
                    <div class="col">Used Coupon (Amount)</div>
                    <div class="col">{{ order.couponCode }} -₹({{order.discountAmount}})</div>
                </div>
                <div class="row">
                    <div class="col">Delivery Method:</div>
                    <div class="col">{{ order.delivery.method }}</div>
                </div>
                <div class="row">
                    <div class="col">Final Amount:</div>
                    <div class="col">₹{{  order.totalAmount }}</div>
                </div>
                <div class="row">
                    <div class="col">Payment Method:</div>
                    <div class="col">{{ order.payment.method}} ({{ order.payment.status}})</div>
                </div>
                <div class="row">
                    <div class="col">Delivery Details:</div>
                    <div class="col">{{ order.delivery.method}} ({{ order.delivery.status}})</div>
                </div>
                <div class="row">
                    {{#if (isEqual order.orderStatus "Cancelled")}}
                <button class="btn btn-sm btn-info cancel-button" disabled>Cancelled</button>
                {{else}}
                <button class="btn btn-sm btn-info cancel-button" data-orderid="{{ order._id}}">Cancel Order</button>
                {{/if}}
                    
                </div>
            </div>
        </div>
        <div class="order-items">
            <h2>Ordered Items</h2>
            <table>
        <thead>
            <tr>
                <th>Image</th>
                <th>Product Name</th>
                <th>Quantity</th>
                <th>Cancel</th>
            </tr>
        </thead>
        <tbody>
                {{#each order.items}}
                <tr>
                    
                    <td style="width: 40%; padding-bottom: 4px;">
                        <a href="/productDetails/{{this.productId}}">
                        {{#if this.images}}
                        <img src="/{{this.images.[0]}}" alt="Product Image" style="width: 15%; height: auto;">
                        {{else}}
                        <p>No Image Available</p>
                        {{/if}}
                        </a>
                    </td>
                    <td style="width: 25%;">{{ this.attributeValue }}</td>
                    <td style="width: 25%;">{{ this.quantity }}</td>
                    <td style="width: 10%;">
                        {{#if (isEqual ../order.orderStatus "Cancelled")}}
                    <button class="btn btn-sm cancel-item-button" disabled>
                        <i class="bi bi-x-lg"></i></button>
                    {{else}}
                    <button class="btn btn-sm cancel-item-button" data-orderid="{{ ../order._id }}" data-itemid="{{ this._id }}">
                    <i class="bi bi-x-lg"></i></button>
                    {{/if}}
                    </td>
                </tr>
                
                {{/each}}
            </tbody>
    </table>
        </div>
    </div>
    <script src="/javascripts/orderDetails.js"></script>
    <script>
        // public/javascripts/orderDetails.js

$(document).ready(function() {
    $('.cancel-item-button').on('click', function(event) {
        var orderId = $(this).data('orderid');
        var itemId = $(this).data('itemid');

        Swal.fire({
            title: 'Are you sure?',
            text: "Do you really want to cancel this item?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, cancel it!',
            cancelButtonText: 'No, keep it'
        }).then(function(result) {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/cancelOrderItem',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ orderId: orderId, itemId: itemId }),
                    success: function(result) {
                        Swal.fire({
                            title: 'Cancelled!',
                            text: result.message,
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(function() {
                            $('tr[data-itemid="' + itemId + '"]').remove();
                            $('#total-amount').text('₹' + result.order.totalAmount.toFixed(2));
                            if (result.order.orderStatus === 'Cancelled') {
                                $('.cancel-item-button').prop('disabled', true);
                            }
                            location.reload();
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error!',
                            text: xhr.responseJSON.message || 'An error occurred while cancelling the item.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            }
        });
    });
});


    </script>
</body>